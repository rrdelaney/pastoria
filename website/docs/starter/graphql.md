---
sidebar_position: 3
---

# GraphQL Schema and Data Fetching

Pastoria uses [Grats](https://grats.capt.dev) to derive a GraphQL schema from annotated
TypeScript functions. Relay powers the client-side data layer. The starter project includes
examples for both so you can extend them quickly.

## Schema fundamentals

The schema lives in `src/schema/`. Two files are provided:

- `context.ts` defines a GraphQL context by extending `PastoriaRootContext` and marking the
  class with `@gqlContext`.
- `hello.ts` exports query fields annotated with `@gqlQueryField`.

```ts
/**
 * A simple hello world query that returns a greeting message.
 *
 * @gqlQueryField
 */
export function hello(ctx: Context): string {
  return 'Hello from Pastoria!';
}
```

```ts
/**
 * Example query showing how to accept arguments.
 * Try querying: { greet(name: "World") }
 *
 * @gqlQueryField
 */
export function greet(args: {name: string}, ctx: Context): string {
  return `Hello, ${args.name}! Welcome to Pastoria.`;
}
```

Every time you add or modify fields, run:

```bash
pnpm generate:schema
```

This command updates the schema artifacts in `__generated__/schema/`.

## Connecting to EntryPoints

Relay EntryPoints preload data before rendering. After you declare a schema field, create a
GraphQL query inside your component and mark it with `@preloadable`:

```tsx
const data = usePreloadedQuery(
  graphql`
    query MyComponentQuery @preloadable {
      hello
    }
  `,
  queries.myComponentQueryRef,
);
```

The entrypoint maps route parameters to query variables and provides the compiled query
parameters generated by Relay:

```tsx
import MyComponentQueryParameters from '#genfiles/queries/MyComponentQuery$parameters';

export const entrypoint = {
  root: JSResource.fromModuleId('m#my-component'),
  getPreloadProps() {
    return {
      queries: {
        myComponentQueryRef: {
          parameters: MyComponentQueryParameters,
          variables: {},
        },
      },
    };
  },
};
```

## Updating Relay artifacts

Whenever you add or edit queries, run:

```bash
pnpm generate:relay
pnpm generate:router
```

Relay compiles `.graphql` artifacts into `__generated__/queries/`, while the router generator
ensures the TypeScript types for `queries` props stay synchronized.

## Tips for evolving the schema

- Reuse the `Context` class to share services (database connections, authentication) across
  resolvers.
- Use TypeScript types for arguments and return values to benefit from Grats' static
  analysis.
- Keep schema modules co-located with related features; the generator does not require a
  single monolithic file.
